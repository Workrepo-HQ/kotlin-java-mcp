name: Check commit emails

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  check-email:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify commit author and committer emails
        run: |
          ALLOWED_EMAILS=(
            "jhby1@users.noreply.github.com"
            "5601842+jhby1@users.noreply.github.com"
            "noreply@github.com"
          )

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            RANGE="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          else
            RANGE="${{ github.event.before }}..${{ github.sha }}"
          fi

          FAILED=0
          while IFS= read -r line; do
            COMMIT=$(echo "$line" | cut -d' ' -f1)
            EMAIL=$(echo "$line" | cut -d' ' -f2)

            MATCH=0
            for allowed in "${ALLOWED_EMAILS[@]}"; do
              if [ "$EMAIL" = "$allowed" ]; then
                MATCH=1
                break
              fi
            done

            if [ "$MATCH" -eq 0 ]; then
              echo "::error::Commit $COMMIT has unauthorized email: $EMAIL"
              FAILED=1
            fi
          done < <(git log "$RANGE" --format="%H %ae" 2>/dev/null; git log "$RANGE" --format="%H %ce" 2>/dev/null)

          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "Allowed emails:"
            for allowed in "${ALLOWED_EMAILS[@]}"; do
              echo "  - $allowed"
            done
            exit 1
          fi

          echo "All commit emails are valid."
