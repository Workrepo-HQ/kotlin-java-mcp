name: Build macOS ARM binary

on:
  push:
    branches: [master]
    tags:
      - 'v*'
  pull_request:
    branches: [master]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal
          rustup target add aarch64-apple-darwin

      - uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release --target aarch64-apple-darwin

      - name: Run tests
        run: cargo test --release --target aarch64-apple-darwin

      - name: Validate tag matches Cargo.toml version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Tag $GITHUB_REF_NAME does not match Cargo.toml version $CARGO_VERSION"
            exit 1
          fi

      - name: Prepare binary
        run: cp target/aarch64-apple-darwin/release/kotlin-java-mcp kotlin-java-mcp-macos-arm64

      - name: Compute SHA256 checksum
        if: startsWith(github.ref, 'refs/tags/')
        id: checksum
        run: |
          SHA256=$(shasum -a 256 kotlin-java-mcp-macos-arm64 | awk '{print $1}')
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Check release does not already exist
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          if gh release view "$GITHUB_REF_NAME" &>/dev/null; then
            echo "::error::Release $GITHUB_REF_NAME already exists"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Upload release asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: kotlin-java-mcp-macos-arm64
          body: |
            ## Checksums

            **SHA256** (`kotlin-java-mcp-macos-arm64`):
            ```
            ${{ steps.checksum.outputs.sha256 }}
            ```
